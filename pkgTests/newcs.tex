%%%==============================================================================
% WinEdt pragmas
% !Mode:: "TeX:EN"
% Default Compile engines:
% !TEX program = pdflatex
% !PDFTeXify ext =  --enable-etex  --restrict-write18
% !PDFLaTeX ext  =  --enable-etex  --restrict-write18
% !BIB program = none
%%%==============================================================================
%% Copyright 2023-present by Alceu Frigeri
%%
%% This work may be distributed and/or modified under the conditions of
%%
%% * The [LaTeX Project Public License](http://www.latex-project.org/lppl.txt),
%%   version 1.3c (or later), and/or
%% * The [GNU Affero General Public License](https://www.gnu.org/licenses/agpl-3.0.html),
%%   version 3 (or later)
%%
%% This work has the LPPL maintenance status *maintained*.
%%
%% The Current Maintainer of this work is Alceu Frigeri
%%
%% This is version {1.4} {2025/10/26}
%%
%% The list of files that compose this work can be found in the README.md file at
%% https://ctan.org/pkg/starray
%%
%%%==============================================================================
\documentclass{article}
\RequirePackage[verbose,a4paper,includemp,marginparwidth=3.5cm,top=2.5cm,bottom=1.5cm,asymmetric]{geometry}
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\usepackage[msg-err=default]{starray}

%\RequirePackage{showframe}
\begin{document}

\ExplSyntaxOn

%%%%%%%%%%%%%%%%
%%%
%%% WARNING: Trying to reduce the clutter
%%%
%%%%%%%%%%%%%%%%  
%\cs_new_protected:Npn \__starray_parsed_generate:nnnnnn #1#2#3#4#5#6
%  {
%    \cs_new_protected:cpn {__starray_parsed_ checked_ #1 #2} #3
%      {
%        \bool_if:NTF \l__starray_parsed_bool
%          { #4 }
%          { #5 }
%      }
%    \cs_new_protected:cpn {__starray_parsed_ nocheck_ #1 #2} #3
%      { #4 }
%    \cs_new_protected:cpn {__starray_parsed_ nocheck_ #1 NN#2} #2
%      { #4 }
%      
%  }
% 

%%
%% base with only #1#2, regardless of signature!
%%
%\cs_new_protected:Npn \__starray_base_X:NN(nxyzn) #1#2
%  {
%    % expands to
%    \real_macro:(nxyzn) with #1 or #2
%  }
%
%\cs_new_protected:Npn \starray_X:n(nxyzn) #1
%  {
%    \__starray_parser:nnTF {\c__starray_idx_ending_bool} {#1}
%      {
%        \__starray_base_X:NN(nxyzn)
%          \l__starray_parsed_ref_tl 
%          \l__starray_parsed_ref_no_idx_ending_tl 
%      }
%      {
%       %err dispatch
%       \__starray_msg_dispatch:
%       \use_none:(xyz...)
%      }
%  }
%
  
%%%
%%%\cs_new_protected:Npn \__starray_base_X:NNn #1#2#3
%%%  {
%%%    \__starray_get_prop:Ve 
%%%      {#1} 
%%%      {#3}
%%%  }
%%%
%%%  
%%%\cs_new_protected:Npn \starray_X:nn #1#2
%%%  {
%%%    \__starray_parser:nnTF {\c__starray_idx_ending_bool} {#1}
%%%      {
%%%        \__starray_base_X:NNn 
%%%          \l__starray_parsed_ref_tl 
%%%          \l__starray_parsed_ref_no_idx_ending_tl 
%%%          {#2}
%%%      }
%%%      {
%%%       %err dispatch
%%%       \__starray_msg_dispatch:
%%%      }
%%%  }
%%%\cs_new_protected:Npn \starray_parsed_nocheck_X:n #1
%%%  {
%%%    \__starray_base_X:NNn 
%%%      \l__starray_parsed_saved_ref_tl 
%%%      \l__starray_parsed_saved_ref_no_idx_ending_tl  
%%%      {#1}
%%%  }
%%%\cs_new_protected:Npn \starray_parsed_check_X:n #1
%%%  {
%%%    \bool_if:NTF \l__starray_parsed_bool
%%%      {
%%%        \__starray_base_X:NNn 
%%%          \l__starray_parsed_ref_tl 
%%%          \l__starray_parsed_saved_ref_no_idx_ending_tl 
%%%          {#1}
%%%      }
%%%      {
%%%       %err parsed
%%%       \__starray_msg_dispatch:
%%%      }
%%%  }
%%%\cs_set_eq:NN \starray_parsed:NNn \__starray_base_X:NNn
%%%
%%%
%%%
%%%\cs_new_protected:Npn \__prg_base_get:NNnN #1#2#3#4
%%%  {
%%%    \prop_get:cnNTF
%%%      {\l__starray_prefix_tl #1 _term_prop}
%%%      {#3}
%%%      #4
%%%      {\prg_return_true:}
%%%      {\prg_return_false:}      
%%%  }
%%%  
%%%    
%%%\cs_show:N \prop_get:cnNTF
%%%\cs_show:N \prop_get:NnNTF
%%%\cs_show:N \__prop_get:NnnTF
%%%    
%%%\cs_new_protected:Npn \mytest:nnN #1#2#3
%%%  {
%%%%    \prg_return_true:
%%%    \prop_get:cnNTF { l__pkginfo_ #1 _prop }  {#2} #3
%%%      {\prg_return_true:}
%%%      {\prg_return_false:}
%%%  }
%%%
%%%
%%%
%%%\cs_show:N \mytest:nnNTF
%%%\cs_show:N \prg_return_true:
%%%\cs_show:N \prg_return_false:
%%%\par
%%%\mytest:nnN {starray}{version}\l__st_tl\exp_end:
%%%  {got:\l__st_tl}
%%%  {got~nothing}    
%%%  \par
%%%
%%%\prg_new_conditional:Npnn \mytest:nnN #1#2#3 {p , T, F , TF}
%%%  {
%%%%    \prg_return_true:
%%%%    \bool_if:NTF #1
%%%    \prop_get:cnNTF { l__pkginfo_ #1 _prop }  {#2} #3
%%%      {\prg_return_true:}
%%%      {\prg_return_false:}
%%%  }
%%%
%%%\cs_show:N \mytest_p:nnN 
%%%\cs_show:N \mytest:nnNT
%%%\cs_show:N \mytest:nnNF
%%%\cs_show:N \mytest:nnNTF
%%%    
%%%\cs_new_protected:Npn \__mytest:nnn #1#2#3
%%%  {
%%%    I~got:~(#1)~(#2)~(#3)
%%%  }
%%%
%%%\__mytest:nnn {A}{B}{C}
%%%
%%%
%%%%\__starray_generate:nnnnnn {Tget_prop:}{n}{\c__starray_idx_ending_bool}
%%%%  {\__starray_get_prop:Ve }
%%%
%%%\par
%%%count:\tl_count:n {}
%%%\par
%%%\tl_set:Nn \l__tmpa_tl {nnn}
%%%
%%%\int_case:nn { \tl_count:N \l__tmpa_tl}
%%%  {
%%%    {0} {NN}
%%%    {1} {NN3}
%%%    {2} {NN34}
%%%    {3} {NN345}
%%%  }
%%%



%%%%%%%%%%%
%%%%%
%%%%% This will create 4 variants
%%%%% {starray_ #cmd# : n #signature# } => standard one, expecting a starray-term-ref
%%%%% {starray_ parsed_ #cmd# : NN #signature# } => expecting two user given variables (from previous parsing)
%%%%% {__starray_ parsed_ nocheck #cmd# : #signature# } => using *last* parsed term, without checking
%%%%% {__starray_ parsed_ checked #cmd# : #signature# } => using *last* parsed term, checking first (if it was OK).
%%%%%
%%%%%%%%%%%
%%%%%
%%%%% #1 -> #cmd#      => base-name
%%%%% #2 -> #signature#
%%%%% #3 -> base-code
%%%%% #4 -> if-parser-failed
%%%%% #5 -> if-parsed-bool-false
%%%%%
%%%%%%%%%%%
%%\cs_new_protected:Npn \__starray_cs_generate:nnnnn #1#2#3
%%  {
%%    \int_case:nn { \tl_count:n {#2} }
%%      {
%%        {0} { \tl_set:Nn \l__starray_use_tl {} }
%%        {1} { \tl_set:Nn \l__starray_use_tl {\use_none:n} }
%%        {2} { \tl_set:Nn \l__starray_use_tl {\use_none:nn} }
%%        {3} { \tl_set:Nn \l__starray_use_tl {\use_none:nnn} }
%%      }
%%      
%%    \cs_new_protected:cn {starray_parsed_ #1 : NN#2}
%%      { #3 }
%%    
%%    \__starray_cs_generate:cVnnnn 
%%      {starray_parsed_ #1 : NN#2} 
%%      \l__starray_use_tl
%%      {#1}{#2}      
%%  }
%%
%%%%%%%%%%%
%%%%%
%%%%% #1 -> base
%%%%% #2 -> none
%%%%% #3 -> cmd radix
%%%%% #4 -> base signature
%%%%% #5 -> in case  parser  err
%%%%% #6 -> in case *parsed* err
%%%%%%%%%%%
%%\cs_new_protected:Npn \__starray_cs_generate:Nnnnnn #1#2#3#4#5#6
%%  {
%%    \cs_new_protected:cpn {__starray_parsed_ nocheck_ #3 : #4}
%%      { #1 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%  
%%    \cs_new_protected:cpn {starray_ #3 : n#4} ##1
%%      { 
%%        \__starray_parser:nnTF {\c__starray_idx_ending_bool}{##1}
%%          { #1 \l__starray_parsed_ref_tl \l__starray_parsed_ref_no_idx_ending_tl}
%%          { #5 #2 }
%%      }
%%
%%    \cs_new_protected:cpn {__starray_parsed_ checked_ #3 : #4}
%%      { 
%%        \bool_if:NTF \l__starray_parsed_bool
%%          { #1 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%          { #6 #2  }
%%      }      
%%  }
%%\cs_generate_variant:Nn \__starray_cs_generate:Nnnnnn {cV}
%%
%%\cs_generate_variant:Nn \prg_new_conditional:Nnn { c }
%%
%%%%%%%%%%%
%%%%%
%%%%% This will create 4 variants (x3 => T,F,TF)
%%%%% {starray_ #cmd# : n #signature# {TF,T,F}} => standard one, expecting a starray-term-ref
%%%%% {starray_ parsed_ #cmd# : NN #signature# {TF,T,F}} => expecting two user given variables (from previous parsing)
%%%%% {__starray_ parsed_ nocheck #cmd# : #signature# {TF,T,F}} => using *last* parsed term, without checking
%%%%% {__starray_ parsed_ checked #cmd# : #signature# {TF,T,F}} => using *last* parsed term, checking first (if it was OK).
%%%%%
%%%%%%%%%%%
%%%%%
%%%%% #1 -> #cmd#      => base-name
%%%%% #2 -> #signature#
%%%%% #3 -> base-code
%%%%% #4 -> if-parser-failed
%%%%% #5 -> if-parsed-bool-false
%%%%%
%%%%%%%%%%%
%%\cs_new_protected:Npn \__starray_prg_generate:nnnnn #1#2#3
%%  {
%%    \int_case:nn { \tl_count:n {#2} }
%%      {
%%        {0} { 
%%              \tl_set:Nn \l__starray_use_tl  {} 
%%              \tl_set:Nn \l__starray_useA_tl {\use_none:n} 
%%              \tl_set:Nn \l__starray_useB_tl {\use_none:nn} 
%%            }
%%        {1} { 
%%              \tl_set:Nn \l__starray_use_tl  {\use_none:n} 
%%              \tl_set:Nn \l__starray_useA_tl {\use_none:nn} 
%%              \tl_set:Nn \l__starray_useB_tl {\use_none:nnn} 
%%            }
%%        {2} { 
%%              \tl_set:Nn \l__starray_use_tl  {\use_none:nn} 
%%              \tl_set:Nn \l__starray_useA_tl {\use_none:nnn} 
%%              \tl_set:Nn \l__starray_useB_tl {\use_none:nnnn} 
%%            }
%%        {3} { 
%%              \tl_set:Nn \l__starray_use_tl  {\use_none:nnn} 
%%              \tl_set:Nn \l__starray_useA_tl {\use_none:nnnn} 
%%              \tl_set:Nn \l__starray_useB_tl {\use_none:nnnnn} 
%%            }
%%      }
%%      
%%    \prg_new_conditional:cnn {starray_parsed_ #1 : NN#2} {T , F , TF}
%%      { #3 }
%%
%%    \__starray_prg_generate:cccVVnnnn
%%      {starray_parsed_ #1 : NN#2 TF} {starray_parsed_ #1 : NN#2 T} {starray_parsed_ #1 : NN#2 F}
%%      \l__starray_useA_tl \l__starray_useB_tl
%%      {#1}{#2}
%%  }
%%
%%
%%
%%%%%%%%%%%
%%%%%
%%%%% #1 -> baseTF
%%%%% #2 -> baseT
%%%%% #3 -> baseF
%%%%% #4 -> noneA
%%%%% #5 -> noneB
%%%%% #6 -> cmd radix
%%%%% #7 -> base signature
%%%%% #8 -> in case  parser  err
%%%%% #9 -> in case *parsed* err
%%%%%%%%%%%
%%\cs_new_protected:Npn \__starray_prg_generate:NNNnnnnnn #1#2#3#4#5#6#7#8#9
%%  {  
%%    \cs_new_protected:cpn {__starray_parsed_ nocheck_ #6 : #7 TF}
%%      { #1 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%      
%%    \cs_new_protected:cpn {__starray_parsed_ nocheck_ #6 : #7 F}
%%      { #2 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%      
%%    \cs_new_protected:cpn {__starray_parsed_ nocheck_ #6 : #7 T}
%%      { #3 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%  
%%    \cs_new_protected:cpn {starray_ #6 : n#7 TF} ##1
%%      { 
%%        \__starray_parser:nnTF {\c__starray_idx_ending_bool}{##1}
%%          { #1 \l__starray_parsed_ref_tl \l__starray_parsed_ref_no_idx_ending_tl}
%%          { #8 #5 }
%%      }
%%
%%    \cs_new_protected:cpn {starray_ #6 : n#7 T} ##1
%%      { 
%%        \__starray_parser:nnTF {\c__starray_idx_ending_bool}{##1}
%%          { #2 \l__starray_parsed_ref_tl \l__starray_parsed_ref_no_idx_ending_tl}
%%          { #8 #4 }
%%      }
%%
%%    \cs_new_protected:cpn {starray_ #6 : n#7 F} ##1
%%      { 
%%        \__starray_parser:nnTF {\c__starray_idx_ending_bool}{##1}
%%          { #3 \l__starray_parsed_ref_tl \l__starray_parsed_ref_no_idx_ending_tl}
%%          { #8 #4 }
%%      }
%%   
%%    \cs_new_protected:cpn {__starray_parsed_ checked_ #6 : #7 TF}
%%      { 
%%        \bool_if:NTF \l__starray_parsed_bool
%%          { #1 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%          { #9 #5 }
%%      }
%%
%%    \cs_new_protected:cpn {__starray_parsed_ checked_ #6 : #7 T}
%%      { 
%%        \bool_if:NTF \l__starray_parsed_bool
%%          { #2 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%          { #9 #4 }
%%      }
%%
%%    \cs_new_protected:cpn {__starray_parsed_ checked_ #6 : #7 F}
%%      { 
%%        \bool_if:NTF \l__starray_parsed_bool
%%          { #3 \l__starray_parsed_saved_ref_tl \l__starray_parsed_saved_ref_no_idx_ending_tl}
%%          { #9 #4 }
%%      }
%%  }
%%\cs_generate_variant:Nn \__starray_prg_generate:NNNnnnnnn {cccVV}
%%


\__starray_cs_generate:nnnnn
  {Xget_prop}{n}
  {
    \__starray_get_prop:Ve {#1}{#3}
  }
  {
    \__starray_msg_dispatch:
    \msg_warning:nnnn {starray} {syntax /  prop} {get:1} {#1}
  } % returns nothing by default
  {
    \msg_warning:nnnn {starray} {syntax /  parsed} {parsed:1} {\starray_parsed_Xget_prop:n}
  }

%\cs_show:N \starray_parsed_Xget_prop:NNn
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:n
%\cs_show:N \__starray_parsed_checked_Xget_prop:n
%\cs_show:N \starray_Xget_prop:nn

\cs_generate_variant:Nn \starray_parsed_Xget_prop:NNn {NNV}
\cs_generate_variant:Nn  \starray_Xget_prop:nn {ve}
%\cs_show:N \starray_parsed_Xget_prop:NNV
%\cs_show:N \starray_Xget_prop:ve


\__starray_prg_generate:nnnnn
  { Xget_prop } { nN }
  {
    \prop_get:cnNTF 
      {\l__starray_prefix_tl #1 _term_prop} {#3} #4
      { 
        \par true~here \par 
        \prg_return_true:
      }
      { 
        \par false~here \par 
        \tl_set:Nn #4 {} 
        \prg_return_false:
      }
  }
  {
    \__starray_msg_dispatch:
    \msg_warning:nnnn {starray} {syntax /  prop} 
      {get:2} {#1}
  }
  {
    \msg_warning:nnnn {starray} {syntax /  parsed} {parsed:1} {\starray_parsed_Xget_prop:n(TF)}
  }

%\cs_show:N \starray_parsed_Xget_prop:NNnNTF
%\cs_show:N \starray_parsed_Xget_prop:NNnNT
%\cs_show:N \starray_parsed_Xget_prop:NNnNF
%
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:nNTF
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:nNT
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:nNF
%
%\cs_show:N \__starray_parsed_checked_Xget_prop:nNTF
%\cs_show:N \__starray_parsed_checked_Xget_prop:nNT
%\cs_show:N \__starray_parsed_checked_Xget_prop:nNF
%
%
%\cs_show:N \starray_Xget_prop:nnNTF
%\cs_show:N \starray_Xget_prop:nnNT
%\cs_show:N \starray_Xget_prop:nnNF

%\prg_generate_conditional_variant:Nnn \starray_parsed_Xget_prop:NNnN {NNV} { T , F , TF }
%
%%\cs_show:N \starray_parsed_Xget_prop:NNVNTF
%%\cs_show:N \starray_parsed_Xget_prop:NNVNT
%%\cs_show:N \starray_parsed_Xget_prop:NNVNF
%
%\prg_generate_conditional_variant:Nnn \__starray_parsed_nocheck_Xget_prop:nN {V} { T , F , TF }
%
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:VNTF
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:VNT
%\cs_show:N \__starray_parsed_nocheck_Xget_prop:VNF
%
\starray_new:n {st-test}
\starray_def_from_keyval:nn {st-test}
  {
    keyA = valA,
    keyB = valB,
    keyC = valC,
    subA . struct =
      {
        keyAA = valAA,
        keyAB = valAB,
        keyAC = valAC,
      }
  }
\starray_new_term:nn {st-test}{}
\starray_new_term:nn {st-test.subA}{}
\starray_new_term:nn {st-test.subA}{}
\starray_new_term:nn {st-test.subA}{}
\starray_new_term:nn {st-test}{}
\starray_new_term:nn {st-test.subA}{}
\starray_new_term:nn {st-test.subA}{}
\starray_new_term:nn {st-test.subA}{}

\par Now~:~
\starray_Xget_prop:nn {st-test}{keyA}\par
%\starray_Xget_prop:nn {st-test.sub}{keyX}\par
add\par

\tl_new:N \tmp_tl
\starray_Xget_prop:nnNTF {st-test}{keyC}\tmp_tl
  {got:\tmp_tl\par}
  {found~nothing : \tmp_tl :\par}

ZZZ\par
%\cs_show:N \starray_Xget_prop:nn
%\cs_show:N \starray_Xget_prop:nnNTF
%\cs_show:N \starray_parsed_Xget_prop:NNnNTF


\ExplSyntaxOff
nothing here.

\end{document}
