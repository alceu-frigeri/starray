% !TEX program = pdflatex
% !TEX ext =  --interaction=nonstopmode --enable-etex --enable-write18
% !BIB program = none

\documentclass{article}
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\RequirePackage[msg-err=default]{starray}

\ExplSyntaxOn

%\msg_redirect_module:nnn { starray / syntax } { warning } { error }

\ExplSyntaxOff

\begin{document}

\ExplSyntaxOn

aaa \iow_newline: > BB \use:nnn { ~ } { ~ } { ~ }
\par
%%%
%%% Testing the creation of a starray with sub-structures, one definition at a time
%%%
\starray_new:n {STtest}
\starray_def_prop:nnn {STtest}{X}{X-default}
\starray_def_prop:nnn {STtest}{Y}{Y-default}

\starray_def_struct:nn {STtest}{SS}
\starray_def_prop:nnn {STtest.SS}{Z}{SS~Z-default}
\starray_def_prop:nnn {STtest.SS}{Zx}{SS~Zx-default}
\starray_def_struct:nn {STtest}{TT}
\starray_def_prop:nnn {STtest.TT}{Z}{TT~Z-default}
\starray_def_prop:nnn {STtest.TT}{Zx}{TT~Zx-default}
\starray_def_struct:nn {STtest.TT}{ZX}
\starray_def_prop:nnn {STtest.TT.ZX}{ZXa}{TT~Zx~ZXa-default}
\starray_def_prop:nnn {STtest.TT.ZX}{Zxb}{TT~Zx~ZXb-default}

\starray_def_struct:nn {STtest.SS}{ZsX}
\starray_def_prop:nnn {STtest.SS.ZsX}{ZsXa}{SS~ZsX~ZsXa-default}
\starray_def_prop:nnn {STtest.SS.ZsX}{Zsxb}{SS~ZsX~ZsXb-default}



\starray_new_term:nn {STtest}{hah}
\starray_new_term:nn {STtest}{}
\starray_new_term:nn {STtest[1].SS}{}

%adding a def property after one being instantiated.
\starray_def_prop:nnn {STtest.SS}{YY}{YY-default}



%\starray_show_def:n {STtest}
%\starray_show_terms:n {STtest}

%adding a def structure after one being instantiated! possible loop ! (if not fixed)
\starray_def_struct:nn {STtest.SS}{TTy}
\starray_def_prop:nnn {STtest.SS.TTy}{TTyZsXa}{TTyTT-ZsXa-default}
\starray_def_prop:nnn {STtest.SS.TTy}{TTyZsxb}{TTyTT-ZsXb-default}

%to fix already instantiated terms.
\starray_fix_terms:n {STtest}


\starray_def_prop:nnn {STtest.SS.TTy}{Z}{TTy-Z-default}


\starray_fix_terms:n {STtest}

This~is~STtest~definition:\starray_show_def_in_text:n {STtest}


\par These~are~STtest~terms:\starray_show_terms_in_text:n {STtest}


        \starray_new_term:nn {STtest.SS}{}
        \starray_new_term:nn {STtest[1].SS}{}

        % TTz isn't part of it... (error testing)
        \starray_new_term:nn {STtest.TTz}{}

        \starray_new_term:nn {STtest.TT}{}
        \starray_new_term:nn {STtest.TT.ZX}{}
        \starray_new_term:nn {STtest.TT.ZX}{}


        \par This~is~'X'~property~from STtest[hah]'hah'~term:\starray_get_prop:nn {STtest[hah]}{X}\par

        % creating a seq and 'inserting' it as a property.
        \seq_new:c {my_seq}
        \seq_put_left:cn {my_seq}{first term}
        \seq_put_left:cn {my_seq}{second term}
        \seq_put_left:cn {my_seq}{third term}
        \seq_put_left:cn {my_seq}{fourth term}
        %\seq_show:c {my_seq}

        \starray_set_prop:nnV {STtest[1]}{X}{\my_seq}
        \seq_new:c {other_seq}
        \starray_get_prop:nnN {STtest[1]}{X}\other_seq
        %\seq_show:c {other_seq}



        %            \starray_get_prop:nn {STtest[1].SS[1]}{Z}\par
        %     \group_begin:
        \starray_set_prop:nnn {STtest[1].SS[1]}{Z}{newZ}
        %      \group_end:

        \starray_set_prop:nnn {STtest[1]}{X}{new1X}
        \starray_set_prop:nnn {STtest[2]}{X}{new2X}


        \starray_set_iter:nn {STtest}{1}


        \starray_get_prop:nn {STtest}{X}\par

        \starray_next_iter:n {STtest}

        \starray_get_prop:nn {STtest}{X}
        \par
        \starray_reset_iter:n {STtest}

        \starray_get_prop:nn {STtest}{X}
        \par


        \starray_get_prop:nnNTF {STtest[1].SS[1]}{Z}\l_tmpb_tl
          {ST1.SS1.Z~it's~there~and~it's~value~is:\l_tmpb_tl}
          {ST1.SS1.Z~it~isn't~there}
\par
        \starray_get_prop:nnNTF {STtest[1].SS[1]}{ZX}\l_tmpb_tl
          {ST1.SS1.ZX~it's~there~and~it's~value~is:\l_tmpb_tl}
          {ST1.SS1.ZX~it~isn't~there}
\par
        \starray_get_prop:nnNTF {STtest[1].SS[2]}{Z}\l_tmpb_tl
          {ST1.SS2.Z~it's~there~and~it's~value~is:\l_tmpb_tl}
          {ST1.SS2.Z~it~isn't~there}
\par
        \starray_get_prop:nnNTF {STtest[1].SS[3]}{Z}\l_tmpb_tl
          {ST1.SS3.Z~it's~there~and~it's~value~is:\l_tmpb_tl}
          {ST1.SS3.Z~it~isn't~there}
\par

\tl_set:Nn \tl_test \int_use:N

\int_new:N \my_int
\starray_get_cnt:nN {STtest} \my_int
Nterms:\starray_get_cnt:n {STtest}.. \int_use:N \my_int\par

xx:\tl_test \my_int \par
        \tl_set:Nn \l_tmpa_tl {
          first = --first-- ,
          last = --last-- ,
          name = --full-name-- ,
          article = o(a) ,
          narticle = (a) ,
          Article = O(A) ,
          Narticle = (A) ,
        }

        \tl_set:Nn \l_tmpb_tl {
          institution = --inst-- ,
          titleinfo = --info-- ,
          email = --- ,
          phone = --- ,
        }

        \starray_new:n {student}



        \starray_def_from_keyval:ne {student}
        {
          \l_tmpa_tl
          Nproc = --- ,
          ID = --- ,
          email = --- ,
          advisor . struct = {
            \l_tmpa_tl
            \l_tmpb_tl
          } ,
          reviewers . struct = {
            \l_tmpa_tl
            \l_tmpb_tl
          }
        }

        \starray_def_from_keyval:ne{student.reviewers}
        {
          \tl_use:N \l_tmpa_tl
          institution = --inst-- ,
          titleinfo = --info-- ,
          email = --- ,
          phone = --- ,
        }

        \starray_def_from_keyval:nn {student.advisor}
        {
          first = --first-- ,
          last = --last-- ,
          name = --full-name-- ,
          article = o(a) ,
          narticle = (a) ,
          Article = O(A) ,
          Narticle = (A) ,
          institution = --inst-- ,
          titleinfo = --info-- ,
          email = --- ,
          phone = --- ,
          somedata . struct = {
            fieldA = field-A ,
            fieldB = field-B ,
            fieldC = field-C ,
          }
        }


        \starray_new_term:nn {student}{}
        \starray_new_term:nn {student.advisor}{}
        \starray_new_term:nn {student.advisor.somedata}{}
        \starray_new_term:nn {student.advisor}{}
        \starray_new_term:nn {student.advisor.somedata}{}
        \starray_new_term:nn {student.advisor.somedata}{}
        \starray_new_term:nn {student.reviewers}{}


\par AAAAAAAAAAAAAAAAAAAAAAAA \par BBBBBBBBBBBBBBBBB \par CCCCCCCCCCCCCCCCCC \par

        \starray_set_from_keyval:nnTF
        {student}
        {
          first = first~name ,
          last = last~name ,
          advisor[2] = {
            first = advisor~first~name ,
            last  = advisor~last~name ,
          } ,
          reviewers = {
            first = reviewer~first~name ,
            last  = reviewer~last~name ,
          } ,
          advisor[1] = {
            first = advisor~first~name ,
            last  = advisor~last~name ,
          } ,
          email
        }
        {\par it~worked!\par}
        {\par oh~well\par}

        \starray_show_def_in_text:n {STtest}
        \starray_show_terms_in_text:n {STtest}
        \starray_show_def:n {student}
        \par
        \starray_show_terms:n {student}
        \starray_show_def_in_text:n {STtest}
        \starray_show_terms_in_text:n {STtest}
        \starray_show_def:n {STtest}
        \starray_show_terms:n {STtest}

        \starray_set_iter:nn {student[1].advisor.somedata}{1}

\seq_new:N \test_seq
\seq_set_from_clist:Nn \test_seq {AA,BB,CC,DD,EE,FF}
\int_new:N \testint
\int_set:Nn \testint {2}
\test_recur:nn  {\testint} {\test_seq}{}

\ExplSyntaxOff
\end{document}
